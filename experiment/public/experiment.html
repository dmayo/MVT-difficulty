<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" type="text/css">
    <title>Object recognition experiment</title>

  </head>
  <body>
    <div id="progressBar" style="width: 100%;background-color: grey;">
      <div id="bar" style="position:absolute;top:0;left:0;width: 0%;height: 3px;background-color: #008000;"></div>
    </div>
    <div id="nav" style="position:absolute;top:120px;right:15px;">
      <b><u>Steps</u></b>
    </div>
    <div class="container mt-4">
      <div id="instructions" style="display:none;">
        <h1>Object recognition experiment</h1>
        <p>Thank you for participating in our study!</p>
        <ul>
          <li><b>Goal:</b> evaluate the limits of the human visual system</li>
          <li><b>Task:</b> look at images of objects that flash quickly on your screen and then tell us what you saw</li>
          <li><b>Requirements:</b> 20/20 vision or 20/20 vision after correction (ex. glasses or contacts)</li>
          <li><b>Time:</b> This experiment should take about <b>15 min</b>. You will receive a code at the end to submit on Mechanical Turk.</li>
        </ul>
        <p>
          Click start. We will walk you through what to do.
        </p>
            <button class="btn btn-primary" onclick="nextState();">Start</button>
          </p>

     </div>

     <div id="overview" style="display:none;">
       <h1>Task Overview</h1>
       <p>
         <div style="max-width: 35em;padding-top:30px;">
           <p> Please read the following:</p>

           <p> You are participating in an experiment in which we are studying people's ability to recognize what object is in an image given varying amounts of image viewing time.</p>

           <p> Included below is an example of what we will ask you to
           view. Look at the center of the cross. When the video
           plays, the cross will briefly change to an image of an
           object and then it will change to an image of a random
           pattern. After you see the image we will ask you what
           object you saw in the image. You will only be able to play
           the video once, so be ready and focused before pressing
           play. The image may disappear too quickly for you to
           immediately be able to name the object that you saw, that's
           okay. Look at the multiple choice list of possible objects,
           think about what you saw, and take your best guess. There
           is no time limit for your response, but you have to respond
           before you can move on to the next image.</P>
           </div>
           <div id="example_container" style="max-width: 35em;padding-top:30px;">
          <div id="example_back" style="background-color:#001ec3;">
            <video id="example"  style="display:none;" width="600">
              <source type="video/mp4" />
            </video>
          </div>
       </div>
       <div class="col"><button class="btn btn-primary" onclick="startExampleVideo()">Play example video</button></div>
       <div style="max-width: 35em;padding-top:30px;">
           <p>The multiple choice list of objects will be the same for
           all the images. Take a minute to read all these object
           names. If you are unfamiliar with a category or find it
           confusing, do a quick search on the web to see some example
           images. YOU DO NOT NEED TO MEMORIZE THESE CATEGORIES,
           they will be shown to you again after you watch each
           video.</p>
           
           <br>   </br>

           <table style="width:100%" id="classes_table">
           </table>

           <br>  </br>

           <p> On the response page, you will see a table with these
           50 options displayed. The order of the options in the
           table will be randomized but all 50 options will always be
           visible. Please take the time to find the correct answer
           if you know what it is. If you do not know what you saw,
           take your best guess. <b>We will know if you are not
           trying to answer correctly and your submission will be
           rejected. Please take this task seriously.</b></p>

           <p> In this experiment you will look at some images and
           tell us what objects you saw. We expect this to take about
           15 minutes. You can take breaks at any time. If you feel
           like you are tired or having trouble focusing please take a
           break and resume the experiment later. Please try to take
           your breaks after submitting a response for an image and
           before clicking play on the next image. Responses are saved
           as you submit them so as long as you return to the same
           link, you will be able to pick up where you left off.</p>

           <p>We would also like you to view our experiment in a quiet and well-lit room if possible.</p>

           <p> Thank you for participating </p>
         </div>
       </p>
       
       <br>   </br><br>   </br>
       
      <button class="btn btn-primary" onclick="nextState();">Continue</button>
     </div>
     
      <div id="IRB" style="display:none;">
        <h1>Informed consent to participate in this study</h1>
        <p>
          <div style="max-width: 35em;padding-top:30px;">
      	    <p>This HIT is part of a scientific research project. Your decision to complete
      	    this HIT is voluntary. There is no way for us to identify you.</p>

      	    <p>The only information we will have, in addition to your responses, is the time at
      	    which you completed the survey and generic non-identifiable about your computer
      	    such as its resolution and browser version number.</p>

      	    <p>The results of the research may be
      	    presented at scientific meetings or published in scientific journals.</p>

      	    <p>The responses collected in this experiment will be released to the scientific
      	    community and the public.</p>

      	    <p>Clicking on the 'SUBMIT' button on the bottom of this page indicates that you
      	    are at least 18 years of age and agree to complete this HIT voluntarily.</p>

            <p><span style="color:red;">**</span> This experiment contains flashing videos. If you have photosensitive epilepsy
            or any sensitivity to flashing lights you are not eligible and cannot participate in this study.</p>
            <p>
              <input style="cursor:pointer;" id="flash_check" type="checkbox" onclick="$('#agree').prop('disabled', function(i, v) { return !v; });"/> <span onclick="$('#flash_check').click();" style="cursor: pointer;"><b>I do not have photosensitive epilepsy or any sensitivity to flashing lights</b></span>
            </p>

      	    <button class="btn btn-primary" id="agree" onclick="nextState();" disabled>Submit</button>
      	  </div>
        </p>
      </div>

        <div id="screen_size" style="display:none;">
            <h3> Let’s find out what your monitor size is.</h2>
            <p style="padding-top:8px;margin-bottom:6px;">Credit and debit cards are the same size all over the world. We are going to use that fact to measure the size of your screen.</p>
            <p style="margin-top:0px;margin-bottom:6px;">Please use any bank card (credit card or debit card) that you have available (it can also be a grocery store membership card, your drivers license, or anything that is of the same format), hold it onto the screen, and adjust the slider below to its size.</p>
            <p style="margin-top:0px;">(If you don't have access to a real card, you can use a ruler to measure image width to 3.37inch or 85.6mm)</p>
            <b style="font-style: italic">Make sure you put the card onto your screen.</b>
            <br>

            <div id="container">
                <div id="slider"></div>
                <br />
                <p><input style="cursor: pointer;" id="card_check" type="checkbox" /> <span onclick="$('#card_check').click();" style="cursor: pointer;">My card couldn't fit the shape of the card image</span></p>
                <img id="card" src="images/card.png" style="width: 50%">
                <br /><br />
                <br />
                <button class="btn btn-primary" onclick="configureBlindSpot()">Click here when you are done!</button>
            </div>
        </div>
        <div id="screen_distance" style="display:none;padding-left:10px;border-left:3px solid #FF8C00;">
          <div id="blind-spot" style="display: none;">
              <h3>Now, let’s quickly test how far away you are sitting.</h3>
              <p>You might know that vision tests at a doctor’s practice often involve chinrests; the doctor basically asks you to sit away from a screen at a specific distance. We are going to create a "virtual chinrest" here by measuring your blindspot.</p>

              <h3>Instructions</h3>
              <div class="row">
                <div class="col col-6">
                  <ul>
                    <li><b>Position your distance from the screen: </b> position your head an arms length away from your screen.
                    <li><b>Finding your blindspot to estimate your screen distance</b>
                    <ol>
                      <li>Focus on the black square in the animation below.</>
                      <li>Close your right eye.</li>
                      <li>Click the button below to start the animation of the red ball. The <b style="color: red">red ball</b> will disappear from your vision as it moves from right to left. This is because the ball will move into your blind spot (the ball will not actually disappear from your screen). <b style="color: red">Press the “Space” key as soon as the ball disappears from your eye sight.</b> The moving ball animation will loop when the ball reaches the black line on the left. If you miss the disappearing just wait for the ball animation to loop, don't press space.</li>
                    </ol>
                  </li>
                </ul>
                  <p>Please do it <b>five</b> times. Keep your right eye closed and hit the <b>“Space”</b> key fast!</p>
                </div>
                <div id="scroll_down" onclick="window.scrollTo(0,document.body.scrollHeight);$(this).hide();" style="z-index:2;border-radius: 10px 10px 0px 0px;cursor: pointer;position:absolute;bottom:0px;right:200px;color:white;background-color:#666666;width:150px;height:50px;text-align:center;padding-top:10px;">
                  Scroll down <img width="30px" src="images/down.gif" />
                </div>
                <div class="col" style="float:right;">
                  <!-- <figure class="figure" width="150">
                    <img src="images/phone_screen.jpg" width="140px;"/>
                    <figcaption class="figure-caption text-right">Hold your phone<br />against your screen<br /> with your arm<br />completely straight</figcaption>
                  </figure> -->
                  <figure class="figure">
                    <img src="images/blind_spot.png" width="300px;"/>
                    <figcaption class="figure-caption text-right">Blind spot task instructions</figcaption>
                  </figure>
                </div>
              </div>
              <hr />
              <div class="row" style="width:100%;text-align:center;">
                <div class="col"><button class="btn btn-primary" id="start" onclick="animateBall()">Start ball animation</button></div>
              </div>
              <br /><br /><br /><br />
              <br /><br /><br /><br />
              <div id="svgDiv" style="width:1000px;height:200px;"></div>
              <br /><br /><br />
              Hit 'space' <div id="click" style='display:inline; color: red; font-weight: bold'>5</div> more times!
          </div>

          <div id="info" style='display:none;'>
              <h3 id="info-h">Estimated viewing distance (in): </h3>
              <h3 id="info-h-2">Estimated screen diagonal (in): </h3>
          </div>
          <button class="btn btn-primary" id="vision_next" onclick="nextState();" style="display:none;">Next</button>
      </div>
      <div id="experiment" style="display:none;text-align:left;margin:auto;width:100%;">
        <div id="viewer_container" style="margin: auto; text-align:center">
<!--          <div id="viewer_back" style="background-color:#001ec3;">-->
              <div id="viewer_instructions" style="text-align:center"></div>
	      <div>
            <video id="viewer" onended="setTimeout(nextViewerState(), 7000)" style="display:none;">
              <source type="video/mp4" />
            </video>
	    </div>
          </div>
    <!--    </div>  -->
        <div id="viewer_next_button" style="width:100%;text-align:center;"><button class="btn btn-primary" onclick="nextViewerState();">Next</button></div>
        <div id="viewer_play_button" style="width:100%;text-align:center;display:none;"><button class="btn btn-primary" onclick="startExperimentVideo()">Play</button></div>

        <div style="position:absolute;"></div>
      </div>
      <div id="response" style="display:none;">
        <div style="text-align:center;">
          <h1>What did you see?</h1>
          <p>
            <div id="response_buttons"></div></p><br /><br />
          <button class="btn btn-primary" onclick="submitResponse();nextState();" id="submit_response" disabled>Submit</button>
        </div>
      </div>
      <div id="upload" style="display:none;">
        <h1>Upload your video</h1>
        <p>
          Go to http://coats.csail.mit.edu:8003/upload.html on your phone and upload all of the videos that you recorded.
        </p>
        <button class="btn btn-primary" onclick="nextState()">Done</button>
      </div>
      <div id="done" style="display:none;">
        <p>Your code is: <span id="done_code"></span></p>
      </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <!-- SVG.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.min.js"></script>
    <!-- script -->
    <script src="js/virtual_chinrest.js"></script>

    <script src="js/experiment.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.10.0/js/md5.min.js"></script>

    <script>

    window.onbeforeunload = function() {
        return true;
    };

      let experiment_start_time = new Date().getTime();
      let urlParams;
      var match,
          pl     = /\+/g,  // Regex for replacing addition symbol with a space
          search = /([^&=]+)=?([^&]*)/g,
          decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
          query  = window.location.search.substring(1);

      urlParams = {};
      while (match = search.exec(query)){
         urlParams[decode(match[1])] = decode(match[2]);
      }


      let link = "practice";
      if(("link" in urlParams) && ("b" in urlParams) && ("c" in urlParams) && ("d" in urlParams)) {
         link = urlParams["link"];
         assignment_id = urlParams["b"];
         hit_id = urlParams["c"];
         worker_id = urlParams["d"];
      } else {
         alert("Something went wrong with your link. Please refresh on Mechanical Turk.");
    }
      if(link == "practice"){
        alert("This is a practice run to get you familiar with our experiment. Your responses will not be recorded.");
      }


      let data_files = {};
      let resume_from = 0;
      $.ajax({
        dataType: "json",
        type: 'POST',
        url: "/get_data",
        data: urlParams,
        async: false,
        success: function(data) {
          data_files = data[0];
          resume_from = data[1];
        }
      });
      console.log("URL Parameters", urlParams);
      if(resume_from>0){
        alert('This experiment will resume from image number '+resume_from+' after you complete the screen size and distance setps.')
      }
      console.log("Data files", data_files);
      let videos = [];
      let video_data = {};
      $.ajax({
        dataType: "json",
        url: "experiment_data/"+data_files["video_data"],
        async: false,
        success: function(data) {
          video_data = data;
        }
		 });

      videos = video_data["videos"]
      let classes = video_data["classes"];
      console.log(classes);
		 

      let order_num = 0;
      $.ajax({
        dataType: "json",
        type: 'POST',
        url: "/get_order_num",
        data: {"link_id": link, "assignment_id": assignment_id},
        async: false,
        success: function(data) {
          order_num = data[0];
        }
      });
      console.log("order num", order_num);

      
      /* small-scale (one order per link)
      let order = [];
      $.ajax({
        dataType: "json",
        url: "experiment_data/video_orders/"+data_files["order"],
        async: false,
        success: function(data) {
          order = data;
        }
      });
      */

      let order = [];
      $.ajax({
        dataType: "json",
        url: "experiment_data/video_orders/"+data_files["order"]+"/"+order_num+".json",
        async: false,
        success: function(data) {
          order = data;
        }
      });

    videosDict = {};
    for(let i=0; i<videos.length;i++){
		    vid = videos[i]
		    videosDict[vid["video"]] = vid
		    }
		
		 

		 
      videos=[]
      for(let i=0;i<order.length;i++){
		     videos.push(videosDict[order[i]]);
      }
      

      let task_length = videos.length
      console.log('video list', videos);
      let viewerInstructionsState = 0;
      let viewerInstructions = ["images/steps5_no_phone_block.png", "images/steps2_no_phone_block.png"];
      let videoWidth = 600;
      let response_start_time;

      let numExperiments = videos.length;
      let currentExperiment = resume_from;
      let states = [['Consent','IRB'],
                    ['Overview', 'overview'],
                    ['Instructions', 'instructions'],
                    ['Screen size','screen_size'],
                    ['Screen distance','screen_distance'],
                    ['Experiment ('+currentExperiment+'/'+numExperiments+')','experiment'],
                    ['Response ('+currentExperiment+'/'+numExperiments+')','response'],
                    // ['Upload recording','upload'],
                    ['Done code','done']];
      for (let i=0;i<states.length;i++){
        $("#nav").append("<p id='s"+i+"'>"+states[i][0]+"</p>");
      }
      currentState = 0;
      if(states[currentState][1] == "experiment"){
        startExperiment();
      }
      barTotal = states.length+numExperiments*2-2-1;
      barCount = currentState;
      function updateBar(){
        barCount++;
        $("#bar").width(Math.round((barCount/barTotal)*100)+"%");
      }
      $("#"+states[currentState][1]).show();
                      function nextState(){
                      
                      console.log("current state " + currentState);
        updateBar();
        $("#"+states[currentState][1]).hide();
        if(states[currentState][1] == "experiment"){
          currentExperiment++;
          $("#s"+currentState).text('Experiment ('+currentExperiment+'/'+numExperiments+')');
          if(currentExperiment == numExperiments){
            $("#s"+currentState).append(" ✓");
          }
          currentState++;
        }
        else if(states[currentState][1] == "response"){
          $("#s"+currentState).text('Response ('+currentExperiment+'/'+numExperiments+')');
          if(currentExperiment == numExperiments){
            $("#s"+currentState).append(" ✓");
            currentState++;
          }
          else{
            currentState--;
        } 
          }
        else{
          $("#s"+currentState).append(" ✓");
          currentState++;
        }

                      if(states[currentState][1] == "done") {
                      console.log("here 1");
                      var done_code = md5(assignment_id).substr(0, 4);
                      $("#done_code").html(done_code);
                      }
        $("#"+states[currentState][1]).show();
        if(states[currentState][1] == "experiment"){
            startExperiment();
        }
        else if(states[currentState][1] == "response"){
            startResponse();
        }
        else if(states[currentState][1] == "overview"){
            buildClassesTable();
        }
      }
      function submitResponse(){
          let response_end_time = new Date().getTime();
	  $.ajax({
	      dataType: "json",
	      type: "POST",
	      url: "/update_timestamp",
	      data: {"assignment_id": assignment_id,
		     "timestamp": {"trial_num": currentExperiment-1,
				   "start_time": experiment_start_time}
		    },
	      async: false,
	      success: function(data) {
		  updated = data[0]
	      }

	  })
	  
	  console.log('current Experiment', currentExperiment, 'video num', order[currentExperiment-1]);
        $.ajax({
          dataType: "json",
          type: 'POST',
          url: "/submit_response",
          data: {"link_id": link,
                 "trial_num": (currentExperiment-1),
                 "video_num": order[currentExperiment-1],
		 //"video_num2": videos
		 "video": videos[currentExperiment-1]["video"],
                 //"response": $("input[name='response']:checked").val(),
                 //"response_position": $("input[name='response']:checked").attr('id').substring(1),
                 "response": $("#response_box").val(),
		 "task_length": task_length,
                 "response_time": (response_end_time-response_start_time),
                 "total_elapsed_time": (response_end_time-experiment_start_time),
                 "video_height": videoHeight,
                 "view_distance": data["viewDistance_mm"],
                 "px2mm": data["px2mm"],
                 "screen_width_px": screen.width,
                 "screen_height_px": screen.height,
                 "window_width_px": window.innerWidth,
                 "window_height_px": window.innerHeight,
                 "device_pixel_ratio": window.devicePixelRatio,
                 "color_depth": screen.colorDepth,
                      "user_agent": navigator.userAgent,
                      "assignment_id": assignment_id,
                      "hit_id": hit_id,
                      "worker_id": worker_id,
                },
          async: false,
          success: function(data) {
            data_files = data;
          }
        });
        //console.log(link, currentExperiment, $("input[name='response']:checked").val());
          console.log(link, currentExperiment,
                      $("#response_box").val());
      }
    </script>
  </body>
</html>
